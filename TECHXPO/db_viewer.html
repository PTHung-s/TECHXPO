<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Kiosk DB Viewer</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üíæ</text></svg>">
<style>
 body {font-family: system-ui, Arial, sans-serif; margin: 1.5rem; background:#f7f9fb;}
 h1 {margin-top:0;}
 table {border-collapse: collapse; width: 100%; margin-bottom:2rem; background:#fff;}
 th, td {border:1px solid #ccc; padding:6px 8px; font-size:14px; vertical-align:top;}
 th {background:#eef; position:sticky; top:0;}
 code {background:#eee; padding:2px 4px; border-radius:3px;}
 .json {white-space:pre-wrap; font-family:monospace; max-height:200px; overflow:auto;}
 .section {box-shadow:0 1px 3px rgba(0,0,0,.1); padding:1rem; margin-bottom:2rem; border-radius:6px; background:#fff;}
 .badge {display:inline-block; background:#0366d6; color:#fff; padding:2px 6px; border-radius:3px; font-size:12px;}
 .filter-box {margin-bottom:1rem;}
</style>
</head>
<body>
<h1>üìã Kiosk Database Viewer</h1>
<p>T·∫£i file n√†y b·∫±ng tr√¨nh duy·ªát t·∫°i c√πng th∆∞ m·ª•c <code>kiosk.db</code>. Kh√¥ng c√≥ backend; ch·ªâ ƒë·ªçc SQLite qua WebAssembly.</p>
<div class="filter-box">
  L·ªçc kh√°ch h√†ng: <input id="customerFilter" placeholder="Nh·∫≠p t√™n ho·∫∑c SƒêT..." size="30" />
  <button onclick="loadAll()">Reload</button>
</div>
<div class="section">
  <h2>Kh√°ch h√†ng</h2>
  <table id="customersTbl">
    <thead><tr><th>ID</th><th>T√™n</th><th>Phone</th><th>S·ªë l∆∞·ª£t kh√°m</th><th>Facts</th><th>Summary</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<div class="section">
  <h2>L∆∞·ª£t kh√°m</h2>
  <table id="visitsTbl">
    <thead><tr><th>Visit ID</th><th>Customer ID</th><th>Th·ªùi gian</th><th>Summary</th><th>Facts</th><th>Chi ti·∫øt</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
document.getElementById('customerFilter').addEventListener('input', ()=> renderCustomers(globalDb));
<!-- UMD build c·ªßa sql.js cung c·∫•p h√†m to√†n c·ª•c initSqlJs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js" referrerpolicy="no-referrer"></script>
<script>
(function(){
  let SQL_DB_INSTANCE = null;
  let SQL_WASM = null;

  async function openDb() {
    if(!SQL_WASM) {
      if(typeof initSqlJs !== 'function') throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán sql.js');
      SQL_WASM = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}` });
    }
    const resp = await fetch('kiosk.db');
    if(!resp.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c kiosk.db (h√£y ch·∫°y qua HTTP server, kh√¥ng m·ªü file:// n·∫øu b·ªã l·ªói)');
    const buf = await resp.arrayBuffer();
    return new SQL_WASM.Database(new Uint8Array(buf));
  }

  function q(db, sql, params=[]) { return db.prepare(sql, params); }

  function renderCustomers(db) {
    const filter = document.getElementById('customerFilter').value.toLowerCase();
    const stmt = q(db, `SELECT c.id, c.name, c.phone, c.facts, c.last_summary, COUNT(v.visit_id) AS cnt
                      FROM customers c LEFT JOIN visits v ON v.customer_id=c.id
                      GROUP BY c.id ORDER BY cnt DESC, c.name`);
    const tbody = document.querySelector('#customersTbl tbody');
    tbody.innerHTML='';
    while(stmt.step()) {
      const {id,name,phone,facts,last_summary,cnt} = stmt.getAsObject();
      const text = `${name||''} ${phone||''}`.toLowerCase();
      if(filter && !text.includes(filter)) continue;
      const tr = document.createElement('tr');
      const factsPreview = (facts || '').length > 50 ? (facts || '').substring(0,50) + '...' : (facts || '');
      const summaryPreview = (last_summary || '').length > 50 ? (last_summary || '').substring(0,50) + '...' : (last_summary || '');
      tr.innerHTML = `<td>${id}</td><td>${name||''}</td><td>${phone||''}</td><td>${cnt}</td><td title="${facts||''}">${factsPreview}</td><td title="${last_summary||''}">${summaryPreview}</td>`;
      tr.onclick = ()=> highlightCustomer(id);
      tbody.appendChild(tr);
    }
    stmt.free();
  }

  function renderVisits(db, customerId=null) {
    let sql = `SELECT visit_id, customer_id, created_at, payload_json, summary, facts_extracted FROM visits ORDER BY created_at DESC LIMIT 500`;
    if(customerId) sql = `SELECT visit_id, customer_id, created_at, payload_json, summary, facts_extracted FROM visits WHERE customer_id = '${customerId.replace(/'/g,"''")}' ORDER BY created_at DESC`;
    const stmt = q(db, sql);
    const tbody = document.querySelector('#visitsTbl tbody');
    tbody.innerHTML='';
    while(stmt.step()) {
      const {visit_id, customer_id, created_at, payload_json, summary, facts_extracted} = stmt.getAsObject();
      let pretty = '';
      try { const o = JSON.parse(payload_json); pretty = JSON.stringify(o,null,2);} catch(e){ pretty = payload_json || ''; }
      const summaryPreview = (summary || '').length > 30 ? (summary || '').substring(0,30) + '...' : (summary || '');
      const factsPreview = (facts_extracted || '').length > 30 ? (facts_extracted || '').substring(0,30) + '...' : (facts_extracted || '');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${visit_id}</td><td>${customer_id}</td><td>${created_at}</td><td title="${summary||''}">${summaryPreview}</td><td title="${facts_extracted||''}">${factsPreview}</td><td><div class='json'>${pretty}</div></td>`;
      tbody.appendChild(tr);
    }
    stmt.free();
  }

  async function loadAll(){
    try {
      if(SQL_DB_INSTANCE) { try { SQL_DB_INSTANCE.close(); } catch(e){} }
      SQL_DB_INSTANCE = await openDb();
      renderCustomers(SQL_DB_INSTANCE);
      renderVisits(SQL_DB_INSTANCE);
    } catch(e) {
      alert(e.message);
    }
  }

  function highlightCustomer(id){
    renderVisits(SQL_DB_INSTANCE, id);
    [...document.querySelectorAll('#customersTbl tbody tr')].forEach(tr=>{
      tr.style.background = tr.firstChild.textContent===id ? '#ffd' : '';
    });
  }

  // Expose to√†n c·ª•c cho onclick & debug
  window.loadAll = loadAll;
  window.highlightCustomer = highlightCustomer;

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('customerFilter').addEventListener('input', ()=> renderCustomers(SQL_DB_INSTANCE));
    loadAll();
  });
})();
</script>
</body>
</html>

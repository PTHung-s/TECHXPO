<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Kiosk Bác sĩ Ảo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --panel:#1e293b; --accent:#2563eb; --ok:#10b981; --warn:#fbbf24; --err:#f87171; }
    * { box-sizing:border-box; }
    body { margin:0; background:var(--bg); color:#f1f5f9; font-family:system-ui, Arial, sans-serif; }
    h1 { font-size:1.1rem; margin:0; font-weight:600; }
    header { display:flex; justify-content:space-between; align-items:center; padding:1rem 1.25rem; background:var(--panel); }
    main { max-width:1180px; margin:0 auto; padding:1.25rem; }
    button { cursor:pointer; font-weight:600; border:none; border-radius:0.55rem; padding:0.65rem 1rem; background:var(--accent); color:#fff; font-size:.9rem; }
    button:disabled { background:#334155; cursor:not-allowed; }
    .grid { display:grid; grid-template-columns: 310px 1fr 360px; gap:1rem; align-items:start; }
    .panel { background:var(--panel); padding:1rem 1rem 1.1rem; border-radius:0.9rem; position:relative; min-height:80px; }
    .panel h2 { margin:0 0 .6rem; font-size:.95rem; font-weight:600; letter-spacing:.5px; }
    .badge { display:inline-block; padding:0.15rem .55rem; font-size:.65rem; border-radius:999px; background:#334155; text-transform:uppercase; letter-spacing:.5px; margin-left:.4rem; }
    .badge.ok { background:var(--ok); color:#032c1d; }
    .badge.wait { background:var(--warn); color:#3b2f02; }
    .badge.err { background:var(--err); }
    #log { font-size:.7rem; line-height:1.25; max-height:260px; overflow:auto; background:#020617; padding:.6rem .7rem; border-radius:.6rem; }
    #controls { display:flex; gap:.55rem; flex-wrap:wrap; }
    #landing { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:4rem 1rem; }
    #landing button { width:160px; height:160px; border-radius:50%; font-size:1.05rem; box-shadow:0 0 0 0 rgba(37,99,235,.55); animation:pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(37,99,235,.55);} 70% { box-shadow:0 0 0 40px rgba(37,99,235,0);} 100% { box-shadow:0 0 0 0 rgba(37,99,235,0);} }
    .hidden { display:none !important; }
    .row { margin-bottom:.4rem; font-size:.8rem; }
    .row label { opacity:.7; display:block; font-size:.65rem; text-transform:uppercase; letter-spacing:.5px; }
    .pill-btn { background:#334155; color:#f1f5f9; font-size:.6rem; padding:.25rem .55rem; border-radius:.5rem; margin-right:.4rem; }
    .stack { display:flex; flex-direction:column; gap:.5rem; }
    .fade { animation:fade .35s ease; }
    @keyframes fade { from { opacity:0; transform:translateY(4px);} to { opacity:1; transform:translateY(0);} }
    .muted { opacity:.65; }
    .two-col { display:grid; grid-template-columns:1fr 1fr; gap:.4rem .8rem; }
  </style>
</head>
<body>
  <header>
    <h1>Bác sĩ Ảo</h1>
    <div id="connState" class="badge">DISCONNECTED</div>
  </header>
  <main>
    <section id="landing">
      <button id="btnStart">BẮT ĐẦU</button>
      <p style="margin-top:1.1rem; font-size:.8rem; max-width:420px; text-align:center;" class="muted">Nhấn để kết nối và cho phép microphone. Bác sĩ ảo sẽ hỏi họ tên và số điện thoại trước.</p>
    </section>
    <section id="inCall" class="hidden">
      <div style="margin-bottom:.9rem; display:flex; gap:.6rem; flex-wrap:wrap;" id="controls">
        <button id="btnHangup">Thoát</button>
        <button id="btnMute">Tắt mic</button>
        <button id="btnUnmute" disabled>Bật mic</button>
      </div>
      <div class="grid">
        <div class="panel fade" id="identityPanel">
          <h2>Thông tin bệnh nhân <span id="identityBadge" class="badge wait">Chưa có</span></h2>
          <div id="identityBody" class="muted" style="font-size:.75rem;">Sẽ hiển thị sau khi hệ thống ghi nhận.</div>
        </div>
        <div class="panel fade" id="centerPanel">
          <h2>Âm thanh</h2>
          <audio id="remoteAudio" autoplay playsinline></audio>
          <div class="row" style="margin-top:.6rem; font-size:.7rem;">Nghe trả lời ở đây. (Không có video)</div>
          <h2 style="margin-top:1rem;">Log</h2>
          <div id="log"></div>
        </div>
        <div class="panel fade" id="bookingPanel">
          <h2>Lịch hẹn <span id="bookingBadge" class="badge">Chưa đặt</span></h2>
          <div id="bookingBody" class="muted" style="font-size:.75rem;">Chưa có thông tin.</div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { Room, RoomEvent, createLocalAudioTrack } from 'https://esm.sh/livekit-client@2'

    const btnStart = document.getElementById('btnStart')
    const btnHangup = document.getElementById('btnHangup')
    const btnMute = document.getElementById('btnMute')
    const btnUnmute = document.getElementById('btnUnmute')
    const landing = document.getElementById('landing')
    const inCall = document.getElementById('inCall')
    const logEl = document.getElementById('log')
    const connState = document.getElementById('connState')
    const remoteAudio = document.getElementById('remoteAudio')
    const identityBody = document.getElementById('identityBody')
    const identityBadge = document.getElementById('identityBadge')
    const bookingBody = document.getElementById('bookingBody')
    const bookingBadge = document.getElementById('bookingBadge')

    let room, localTrack
    let identityConfirmed = false

    function log(msg){
      const atBottom = logEl.scrollTop + logEl.clientHeight >= logEl.scrollHeight - 5
      const line = document.createElement('div')
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`
      logEl.appendChild(line)
      if(atBottom) logEl.scrollTop = logEl.scrollHeight
    }

    async function fetchToken(identity){
      const r = await fetch(`/api/token?identity=${encodeURIComponent(identity)}`)
      if(!r.ok) throw new Error('Token fetch failed')
      return r.json()
    }

    function showCall(){ landing.classList.add('hidden'); inCall.classList.remove('hidden') }
    function showLanding(){ landing.classList.remove('hidden'); inCall.classList.add('hidden') }

    function sendData(obj){
      if(!room) return
      try { const payload = new TextEncoder().encode(JSON.stringify(obj)); room.localParticipant.publishData(payload) } catch(e){ log('Send data err '+ e.message) }
    }

    function renderIdentity(data){
      identityBody.innerHTML = `
        <div class="two-col">
          <div><label>Họ tên</label>${data.patient_name || '<i>(chưa)</i>'}</div>
          <div><label>SĐT</label>${data.phone || '<i>(chưa)</i>'}</div>
        </div>
        <div style="margin-top:.55rem; display:flex; gap:.4rem;">
          <button id="btnEditId">Sửa</button>
        </div>
      `
      identityBadge.textContent = identityConfirmed? 'ĐÃ XÁC NHẬN' : 'Đang nhận dạng'
      identityBadge.className = 'badge ' + (identityConfirmed? 'ok':'wait')
      document.getElementById('btnEditId').onclick = () => {
        const n = prompt('Nhập tên (Enter để giữ nguyên)', data.patient_name)
        const p = prompt('Nhập SĐT (Enter để giữ nguyên)', data.phone)
        sendData({type:'identity_corrected', patient_name:n||data.patient_name, phone:p||data.phone})
      }
    }

    function renderBookingPending(){
      bookingBadge.textContent = 'Đang xử lý'
      bookingBadge.className = 'badge wait'
      bookingBody.innerHTML = '<div class="muted">Đang tìm lịch khám phù hợp...</div>'
    }
    function renderBooking(result){
      bookingBadge.textContent = 'ĐÃ ĐẶT'
      bookingBadge.className = 'badge ok'
      const b = result.booking || result
      bookingBody.innerHTML = `
        <div class="row"><label>Khoa</label>${b.department||''}</div>
        <div class="row"><label>Bác sĩ</label>${b.doctor_name||''}</div>
        <div class="row"><label>Thời gian</label>${b.slot_time||b.appointment_time||''}</div>
        <div class="row"><label>Phòng</label>${b.room||''}</div>
        <div class="row"><label>STT</label>${b.queue_number||''}</div>
        ${b.symptoms?`<div class="row"><label>Triệu chứng</label>${Array.isArray(b.symptoms)? b.symptoms.map(s=>s.name||s).join(', '): b.symptoms}</div>`:''}
      `
    }

    function attachEvents(r){
      r.on(RoomEvent.ConnectionStateChanged, st => connState.textContent = st)
      r.on(RoomEvent.TrackSubscribed, (track) => { if(track.kind==='audio'){ track.attach(remoteAudio); log('Audio từ agent') } })
      r.on(RoomEvent.DataReceived, (payload) => {
        try {
          const msg = JSON.parse(new TextDecoder().decode(payload))
          switch(msg.type){
            case 'identity_captured': log('Nhận identity_captured'); renderIdentity(msg); break
            case 'identity_confirmed': log('Nhận identity_confirmed'); identityConfirmed=true; renderIdentity(msg); break
            case 'booking_pending': log('Nhận booking_pending'); renderBookingPending(); break
            case 'booking_result': log('Nhận booking_result'); renderBooking(msg); break
            case 'wrapup_done': log('Kết thúc phiên'); hangup(); break
            default: log('Data: '+ JSON.stringify(msg));
          }
        } catch(e){ log('Data(raw) '+ payload.byteLength + ' bytes') }
      })
      r.on(RoomEvent.Disconnected, () => { log('Disconnected'); showLanding(); })
    }

  async function start(){
      btnStart.disabled = true
      try {
        const identity = 'web-' + Math.random().toString(36).slice(2,8)
        const { url, token } = await fetchToken(identity)
        room = new Room()
        attachEvents(room)
        const track = await createLocalAudioTrack()
        localTrack = track
        await room.connect(url, token, { autoSubscribe:true })
        await room.localParticipant.publishTrack(track)
        showCall()
        log('Đã tham gia phòng')
      } catch(e){
        log('Join lỗi: '+ e.message)
        btnStart.disabled = false
      }
    }

  async function hangup(){
      try {
        if(localTrack){ localTrack.stop(); localTrack=null }
        if(room){ await room.disconnect(); room=null }
      } catch(e){ log('Hangup err '+ e.message) }
      identityBody.innerHTML = '<span class="muted">Sẽ hiển thị sau khi hệ thống ghi nhận.</span>'
      bookingBody.innerHTML = '<span class="muted">Chưa có thông tin.</span>'
      identityBadge.textContent='Chưa có'; identityBadge.className='badge'
      bookingBadge.textContent='Chưa đặt'; bookingBadge.className='badge'
      identityConfirmed=false
      showLanding()
      btnStart.disabled=false
    }

    function mute(){ if(!localTrack) return; localTrack.mute(); btnMute.disabled=true; btnUnmute.disabled=false }
    function unmute(){ if(!localTrack) return; localTrack.unmute(); btnMute.disabled=false; btnUnmute.disabled=true }

    btnStart.addEventListener('click', start)
    btnHangup.addEventListener('click', hangup)
    btnMute.addEventListener('click', mute)
    btnUnmute.addEventListener('click', unmute)
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Kiosk Bác sĩ Ảo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; min-height:100dvh; display:grid; place-items:center; background:#0f172a; color:#e2e8f0; font-family: system-ui, Arial, sans-serif; }
    #landing { display:grid; place-items:center; gap:1rem; }
    #call { display:none; width:min(800px, 92vw); }
    .round-btn {
      width:120px; height:120px; border-radius:999px; display:grid; place-items:center;
      background:#22d3ee; color:#0f172a; font-weight:800; font-size:1rem; cursor:pointer; border:none;
      box-shadow: 0 10px 30px rgba(34,211,238,.35);
      transition: transform .08s ease, box-shadow .2s ease;
    }
    .round-btn:active { transform: scale(.97); box-shadow: 0 6px 18px rgba(34,211,238,.25); }
    .subtle { color:#94a3b8; font-size:.9rem; text-align:center; }
    .bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .pill { background:#1e293b; padding:.4rem .7rem; border-radius:999px; font-size:.75rem; text-transform:uppercase; letter-spacing:.5px; }
    .end-btn { background:#ef4444; color:#fff; border:none; padding:.6rem 1rem; border-radius:.6rem; font-weight:700; cursor:pointer; }
    .card { background:#0b1220; border:1px solid #1f2937; padding:1rem; border-radius:.8rem; }
    audio { width:100%; }
  </style>
</head>
<body>

  <!-- Landing: chỉ một nút tròn -->
  <section id="landing">
    <button id="btnStart" class="round-btn">Gọi bác sĩ</button>
    <div class="subtle">Nhấn để kết nối tới LiveKit + Agent</div>
  </section>

  <!-- Màn khi đang call -->
  <section id="call">
    <div class="bar">
      <div class="pill" id="state">KẾT NỐI...</div>
      <button id="btnHangup" class="end-btn">Kết thúc</button>
    </div>
    <div class="card">
      <strong>Âm thanh bác sĩ</strong>
      <audio id="remoteAudio" autoplay playsinline></audio>
    </div>
    <div class="card" style="margin-top:1rem;">
      <strong>Nhật ký</strong>
      <div id="log" style="height:160px; overflow:auto; font-size:.9rem;"></div>
    </div>
  </section>

<script type="module">
  import { Room, RoomEvent, createLocalAudioTrack } from 'https://esm.sh/livekit-client@2'

  const landing = document.getElementById('landing')
  const call = document.getElementById('call')
  const btnStart = document.getElementById('btnStart')
  const btnHangup = document.getElementById('btnHangup')
  const stateEl = document.getElementById('state')
  const logEl = document.getElementById('log')
  const remoteAudio = document.getElementById('remoteAudio')

  let room, localTrack

  function log(msg){
    const atBottom = logEl.scrollTop + logEl.clientHeight >= logEl.scrollHeight - 5
    const line = document.createElement('div')
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`
    logEl.appendChild(line)
    if(atBottom) logEl.scrollTop = logEl.scrollHeight
  }

  async function fetchToken(identity){
    const r = await fetch(`/api/token?identity=${encodeURIComponent(identity)}`)
    if(!r.ok) throw new Error('Token fetch failed')
    return r.json() // { url, token, room }
  }

  function showLanding(){
    call.style.display = 'none'
    landing.style.display = 'grid'
    stateEl.textContent = 'KẾT NỐI...'
  }
  function showCall(){
    landing.style.display = 'none'
    call.style.display = 'block'
  }

  function attachRoomEvents(r){
    r.on(RoomEvent.ConnectionStateChanged, s => stateEl.textContent = s)
    r.on(RoomEvent.TrackSubscribed, (track, pub, participant) => {
      if(track.kind === 'audio'){
        track.attach(remoteAudio)
        log('Đã nhận audio từ agent')
      }
    })
    // Lắng nghe gói dữ liệu wrapup_done
    r.on(RoomEvent.DataReceived, (payload, participant, kind) => {
      try {
        const msg = JSON.parse(new TextDecoder().decode(payload))
        log('Data: ' + JSON.stringify(msg))
        if(msg.type === 'wrapup_done'){
          log('Wrap-up xong: đóng cuộc gọi.')
          hangup() // tự thoát phòng & reset UI
        }
      } catch(e){
        log('Data(raw) len=' + payload?.byteLength)
      }
    })
    // Khi participant (agent) rời có thể tự động reset (fallback)
    r.on(RoomEvent.ParticipantDisconnected, (p) => {
      // Nếu agent identity có prefix cấu hình (ví dụ 'agent-' hay 'kiosk')
      if(p.identity && p.identity.toLowerCase().includes('kiosk')){
        log('Agent rời phòng (fallback).')
        hangup()
      }
    })
    r.on(RoomEvent.Disconnected, () => {
      log('Đã rời phòng')
      showLanding()
    })
  }

  async function startCall(){
    btnStart.disabled = true
    try {
      const identity = 'web-' + Math.random().toString(36).slice(2,8)
      const { url, token, room: roomName } = await fetchToken(identity)

      room = new Room()
      attachRoomEvents(room)

      localTrack = await createLocalAudioTrack() // xin quyền mic & tạo track
      await room.connect(url, token, { autoSubscribe: true }) // kết nối LiveKit
      await room.localParticipant.publishTrack(localTrack)     // publish mic
      log('Đã tham gia phòng: ' + roomName)

      showCall()
    } catch (e){
      log('Lỗi: ' + e.message)
      btnStart.disabled = false
    }
  }

  async function hangup(){
    try {
      if(localTrack){ localTrack.stop(); localTrack = null }
      if(room){ await room.disconnect(); room = null }
    } catch {}
    showLanding()
  }

  btnStart.addEventListener('click', startCall)
  btnHangup.addEventListener('click', hangup)
</script>
</body>
</html>
